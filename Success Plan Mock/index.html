<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Success Plan Mockup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .objective-card, .value-item, .stakeholder-card, .modal-container, .mission-goal-item {
            transition: all 0.3s ease-in-out;
        }
        .objective-card.removing, .value-item.removing, .stakeholder-card.removing, .mission-goal-item.removing {
            transform: scale(0.95);
            opacity: 0;
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
            border-width: 0;
        }
        .form-input, .form-select, .form-textarea {
            @apply w-full p-2 border border-slate-300 rounded-lg bg-slate-50 shadow-sm focus:ring-2 focus:ring-cyan-600 focus:border-cyan-600 focus:bg-white transition-all;
        }
        .form-label {
            @apply block text-sm font-medium text-slate-700 mb-1;
        }
        .status-pill {
            @apply text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full;
        }
        .status-green { @apply bg-green-100 text-green-800; }
        .status-yellow { @apply bg-yellow-100 text-yellow-800; }
        .status-red { @apply bg-red-100 text-red-800; }
        .status-gray { @apply bg-slate-200 text-slate-800; }
        .status-cyan { @apply bg-cyan-100 text-cyan-800; }

        /* Modal Styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
        .description-preview {
            @apply w-full p-2 border border-transparent rounded-lg bg-slate-50 text-sm text-slate-600 truncate cursor-pointer hover:bg-slate-100;
        }
        .input-with-icon {
            position: relative;
        }
        .input-with-icon svg {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8; /* slate-400 */
        }
        .input-with-icon input {
            padding-left: 2.5rem;
        }
        .cycle-view-btn {
            @apply px-3 py-1 text-sm font-semibold rounded-md transition-colors bg-cyan-100 text-cyan-800 hover:bg-cyan-200;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-cyan-800 to-emerald-600 text-white shadow-lg">
            <h1 class="text-4xl font-bold">Customer Success Plan</h1>
            <p class="text-cyan-200 mt-2">A collaborative plan to track and achieve desired outcomes. Last updated: August 12, 2025</p>
        </header>

        <!-- Mission Section -->
        <section class="mb-10 bg-white p-6 rounded-xl shadow-sm border border-slate-200/80">
            <h2 class="text-2xl font-bold text-slate-900 mb-4 col-span-full">Our Mission</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <label class="form-label">Mission Description</label>
                    <textarea class="form-textarea resize-y" rows="6" placeholder="Describe the primary business outcome and overall vision for this partnership..."></textarea>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="form-label">Mission Goals</label>
                        <button id="add-mission-goal-btn" class="text-sm bg-emerald-100 text-emerald-800 font-semibold px-3 py-1 rounded-md hover:bg-emerald-200 transition-colors">+ Add Goal</button>
                    </div>
                    <div id="mission-goals-container" class="space-y-2">
                        <!-- Mission goals will be injected here -->
                    </div>
                </div>
            </div>
        </section>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column / Main Content -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Current Objectives Section -->
                <section id="current-objectives">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-slate-900">Current Objectives</h2>
                        <button id="add-objective-btn" class="bg-cyan-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" /></svg>
                            Add Objective
                        </button>
                    </div>
                    <div id="objectives-container" class="space-y-6"></div>
                </section>

                <!-- Past Objectives Achieved Section -->
                <section id="past-objectives">
                    <h2 class="text-2xl font-bold text-slate-900 mb-4">Past Objectives Achieved</h2>
                    <div id="past-objectives-container" class="space-y-6">
                        <div id="no-past-objectives" class="text-center py-10 px-4 bg-white rounded-xl shadow-sm border border-slate-200/80">
                            <p class="text-slate-500">Completed objectives will appear here.</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Column / Sidebar -->
            <div class="space-y-8">
                <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200/80">
                    <h3 class="text-lg font-semibold text-slate-900 mb-3">Plan Details</h3>
                    <div class="space-y-4">
                         <div>
                            <label class="form-label">Overall Health</label>
                            <select id="health-score" class="form-select">
                                <option value="green">ðŸŸ¢ On Track</option>
                                <option value="yellow">ðŸŸ¡ Needs Attention</option>
                                <option value="red">ðŸ”´ At Risk</option>
                            </select>
                        </div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200/80">
                    <h3 class="text-lg font-semibold text-slate-900 mb-3">Key Stakeholders</h3>
                    <div id="stakeholders-container" class="space-y-3 mb-3"></div>
                    <select id="add-stakeholder-select" class="form-select">
                        <option value="">+ Add a contact...</option>
                    </select>
                </section>
                
                <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200/80">
                    <h3 class="text-lg font-semibold text-slate-900 mb-3">Latest Business Review</h3>
                    <div>
                        <label class="form-label">Collateral Link</label>
                        <div class="input-with-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" /></svg>
                            <input type="text" class="form-input" placeholder="https://..."/>
                        </div>
                    </div>
                </section>

                <section id="value-realized" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200/80">
                     <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold text-slate-900">Value Realized</h3>
                        <button id="add-value-btn" class="text-sm bg-emerald-100 text-emerald-800 font-semibold px-3 py-1 rounded-md hover:bg-emerald-200 transition-colors">
                            + Add
                        </button>
                    </div>
                    <div id="value-container" class="space-y-4">
                         <div id="no-value-message" class="text-center py-4 text-slate-500 text-sm">No value items added yet.</div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Add/Edit Objective Modal -->
    <div id="objective-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div id="objective-modal-container" class="modal-container bg-slate-50 rounded-xl shadow-2xl w-full max-w-3xl transform scale-95">
            <div id="objective-modal-body">
                <!-- Objective modal content will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Value Description Modal -->
    <div id="value-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div id="value-modal-container" class="modal-container bg-white rounded-xl shadow-2xl w-full max-w-lg transform scale-95">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-slate-900 mb-4">Edit Value Description</h3>
                <textarea id="value-description-input" class="form-textarea w-full" rows="6"></textarea>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="value-modal-cancel-btn" class="bg-slate-200 text-slate-700 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300">Cancel</button>
                    <button id="value-modal-save-btn" class="bg-cyan-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-cyan-700">Save</button>
                </div>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DATA & STATE ---
    const kpiMap = {
        'Reduce time spent per response': { 
            kpis: [{ name: 'Avg. Response Time', trend: 'down' }],
            data: {
                monthly: { result: '37s', change: '-2s vs. last month' },
                quarterly: { result: '38s', change: '-7s vs. last QTR' },
                annually: { result: '45s', change: '-15s vs. last year' }
            }
        },
        'Adoption': {
            kpis: [{ name: 'Daily Active Users', trend: 'up' }, { name: 'Feature Adoption', trend: 'up' }],
            data: {
                monthly: { result: '1.2k', change: '+15% vs. last month' },
                quarterly: { result: '1.1k', change: '+25% vs. last QTR' },
                annually: { result: '800', change: '+50% vs. last year' }
            }
        },
        'Content library clean up': {
            kpis: [{ name: 'Content Utilization', trend: 'up' }, { name: 'Obsolete Content', trend: 'down' }],
             data: {
                monthly: { result: '30%', change: '+5% vs. last month' },
                quarterly: { result: '25%', change: '+10% vs. last QTR' },
                annually: { result: '15%', change: '+15% vs. last year' }
            }
        },
        'Increase win rate': {
            kpis: [{ name: 'Win Rate', trend: 'up' }, { name: 'Avg. Deal Size', trend: 'up' }],
            data: {
                monthly: { result: '22%', change: '+2% vs. last month' },
                quarterly: { result: '20%', change: '+5% vs. last QTR' },
                annually: { result: '18%', change: '+8% vs. last year' }
            }
        },
    };
    const objectiveOptions = Object.keys(kpiMap);
    const valueOptions = ['Time Savings', 'Win Rate Increase', 'Adoption Rate', 'Cost Reduction', 'Revenue Growth', 'Productivity Gain'];
    const timePeriods = ['monthly', 'quarterly', 'annually'];

    const mockContacts = [
        { id: 1, name: 'Jane Doe', title: 'VP, Sales', email: 'jane.d@example.com' },
        { id: 2, name: 'John Smith', title: 'Project Manager', email: 'john.s@example.com' },
        { id: 3, name: 'Samantha Ray', title: 'Director of Ops', email: 'samantha.r@example.com' },
        { id: 4, name: 'Mike Chen', title: 'Lead Engineer', email: 'mike.c@example.com' }
    ];

    // --- Centralized State ---
    const state = {
        missionGoals: [
            { id: Date.now(), text: 'Time Savings' },
            { id: Date.now() + 1, text: 'Winning More Business' }
        ],
        stakeholders: [mockContacts[0], mockContacts[1]],
        objectives: [{
            id: Date.now(), name: 'Reduce time spent per response', targetDate: '2025-09-30', status: 'In Progress', view: 'quarterly',
            challenges: 'Team members are still learning the new workflow. Some resistance to change from senior members.', s4Link: 'https://s4.example.com/ticket/12345',
            kpiGoal: 'Reduce average response time from 45s to 30s.', nextSteps: 'Hold a workshop on advanced features next Friday.'
        }, {
            id: Date.now() + 2, name: 'Content library clean up', targetDate: '2025-10-31', status: 'Not Started', view: 'quarterly',
            challenges: 'Lack of clear ownership for older content.', s4Link: 'https://s4.example.com/ticket/12346',
            kpiGoal: 'Archive 50% of obsolete content and increase utilization by 15%.', nextSteps: 'Work with Samantha Ray to identify content owners for each category.'
        }],
        pastObjectives: [],
        valueRealized: [{ id: Date.now(), type: 'Time Savings', description: 'Saved ~5 hours/week per agent in Q3 by streamlining the content search and response process.', date: '2025-07-30', link: 'https://datastudio.example.com/report/1' }],
        editingValueId: null,
    };

    // --- DOM REFERENCES ---
    const objectivesContainer = document.getElementById('objectives-container');
    const pastObjectivesContainer = document.getElementById('past-objectives-container');
    const noPastObjectivesMessage = document.getElementById('no-past-objectives');
    const valueContainer = document.getElementById('value-container');
    const noValueMessage = document.getElementById('no-value-message');
    const stakeholdersContainer = document.getElementById('stakeholders-container');
    const addStakeholderSelect = document.getElementById('add-stakeholder-select');
    const missionGoalsContainer = document.getElementById('mission-goals-container');
    
    // Modals
    const objectiveModal = new Modal('objective-modal-overlay', 'objective-modal-container');
    const valueModal = new Modal('value-modal-overlay', 'value-modal-container');
    
    // --- TEMPLATING FUNCTIONS ---
    const getStatusPillClass = (status) => ({
        'In Progress': 'status-cyan', 'At Risk': 'status-yellow',
        'Completed': 'status-green', 'Not Started': 'status-gray'
    })[status] || 'status-gray';
    
    const createKpiCards = (objective) => {
        const objectiveData = kpiMap[objective.name];
        if (!objectiveData) return '';
        const kpis = objectiveData.kpis;
        const viewData = objectiveData.data[objective.view];
        if (!kpis || !viewData) return '<p class="text-sm text-slate-500 mt-2">No KPI data for this view.</p>';
        return kpis.map(kpi => {
            const trendColor = kpi.trend === 'up' ? 'text-green-600' : 'text-red-600';
            const trendIcon = kpi.trend === 'up' ? 'â†‘' : 'â†“';
            return `<div class="bg-white rounded-lg p-3 flex-1 border border-slate-200">
                        <p class="text-sm text-slate-500">${kpi.name}</p>
                        <div class="flex items-baseline space-x-2 mt-1">
                            <p class="text-2xl font-bold text-slate-900">${viewData.result || 'N/A'}</p>
                            <p class="text-sm font-semibold ${trendColor}">${trendIcon} ${viewData.change || ''}</p>
                        </div>
                    </div>`;
        }).join('');
    };

    const createObjectiveCard = (objective) => {
        const isCompleted = objective.status === 'Completed';
        const statusPillClass = getStatusPillClass(objective.status);
        return `<div id="objective-${objective.id}" class="objective-card bg-white p-6 rounded-xl shadow-sm border border-slate-200/80" data-id="${objective.id}">
                    <div class="space-y-5">
                        <div class="flex justify-between items-start">
                            <div>
                               <h3 class="font-semibold text-lg text-slate-800">${objective.name}</h3>
                                <div class="flex items-center mt-2">
                                    <select class="status-select form-select text-xs font-semibold p-1 pr-7 border-0 rounded-full ${statusPillClass}" ${isCompleted ? 'disabled' : ''}>
                                        <option value="Not Started" ${objective.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                        <option value="In Progress" ${objective.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="At Risk" ${objective.status === 'At Risk' ? 'selected' : ''}>At Risk</option>
                                        <option value="Completed" ${objective.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                    </select>
                                    <p class="text-sm text-slate-500 ml-2">Target: ${objective.targetDate || 'Not set'}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                 <button class="view-details-btn text-sm font-semibold text-cyan-600 hover:text-cyan-800">View Details</button>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="form-label text-xs uppercase tracking-wider">Current Results</label>
                                <button class="cycle-view-btn">
                                    Time Period: <span class="font-bold capitalize">${objective.view}</span>
                                </button>
                            </div>
                            <div class="flex gap-4 mt-1">${createKpiCards(objective)}</div>
                        </div>
                    </div>
                </div>`;
    };
    
    const createValueItem = (item) => `
        <div id="value-${item.id}" class="value-item bg-slate-50 p-4 rounded-lg border space-y-3" data-id="${item.id}">
            <div class="flex items-center justify-between">
                <select class="form-select text-sm font-semibold p-1 border-0 bg-transparent value-type-select w-auto">
                    ${valueOptions.map(opt => `<option ${opt === item.type ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>
                <button class="remove-value-btn text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" /></svg>
                </button>
            </div>
            <div>
                <label class="form-label text-xs">Description</label>
                <div class="flex items-center space-x-2">
                    <p class="description-preview flex-1">${item.description || 'Click to add description...'}</p>
                    <button class="edit-description-btn text-sm font-semibold text-cyan-600 hover:text-cyan-800">Edit</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="form-label text-xs">Date Realized</label>
                    <input type="date" value="${item.date}" class="form-input text-sm">
                </div>
                <div>
                    <label class="form-label text-xs">Reference Link</label>
                    <div class="input-with-icon">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" /></svg>
                        <input type="text" value="${item.link}" placeholder="https://" class="form-input text-sm">
                    </div>
                </div>
            </div>
        </div>`;

    const createStakeholderCard = (stakeholder) => `
        <div id="stakeholder-${stakeholder.id}" class="stakeholder-card flex items-center justify-between p-3 bg-slate-50 rounded-lg border" data-id="${stakeholder.id}">
            <div>
                <p class="font-semibold text-slate-800">${stakeholder.name}</p>
                <p class="text-sm text-slate-500">${stakeholder.title} &middot; <a href="mailto:${stakeholder.email}" class="text-cyan-600 hover:underline">${stakeholder.email}</a></p>
            </div>
            <button class="remove-stakeholder-btn text-slate-400 hover:text-red-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
            </button>
        </div>`;

    const createMissionGoalItem = (goal) => `
        <div id="mission-goal-${goal.id}" class="mission-goal-item flex items-center justify-between p-2 bg-slate-50 rounded-lg border" data-id="${goal.id}">
            <input type="text" class="form-input border-0 bg-transparent text-sm" value="${goal.text}">
            <button class="remove-mission-goal-btn text-slate-400 hover:text-red-600">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>
        </div>`;

    // --- RENDER FUNCTIONS (Targeted) ---
    const renderObjectives = () => {
        objectivesContainer.innerHTML = state.objectives.map(createObjectiveCard).join('') || '<p class="text-slate-500 text-center py-4">No active objectives. Add one to get started!</p>';
        pastObjectivesContainer.innerHTML = state.pastObjectives.map(obj => createObjectiveCard(obj)).join('');
        noPastObjectivesMessage.style.display = state.pastObjectives.length === 0 ? 'block' : 'none';
        if (state.pastObjectives.length > 0 && !pastObjectivesContainer.contains(noPastObjectivesMessage)) {
             pastObjectivesContainer.prepend(noPastObjectivesMessage);
        } else if (state.pastObjectives.length === 0) {
            pastObjectivesContainer.innerHTML = '';
            pastObjectivesContainer.appendChild(noPastObjectivesMessage);
        }
    };
    const renderValueRealized = () => {
        valueContainer.innerHTML = state.valueRealized.map(createValueItem).join('');
        noValueMessage.style.display = state.valueRealized.length === 0 ? 'block' : 'none';
    };
    const renderStakeholders = () => {
        stakeholdersContainer.innerHTML = state.stakeholders.map(createStakeholderCard).join('');
        const unselectedContacts = mockContacts.filter(mc => !state.stakeholders.find(sc => sc.id === mc.id));
        addStakeholderSelect.innerHTML = '<option value="">+ Add a contact...</option>' + unselectedContacts.map(c => `<option value="${c.id}">${c.name} (${c.title})</option>`).join('');
    };
    const renderMissionGoals = () => {
        missionGoalsContainer.innerHTML = state.missionGoals.map(createMissionGoalItem).join('');
    };
    const renderAll = () => {
        renderObjectives();
        renderValueRealized();
        renderStakeholders();
        renderMissionGoals();
    };

    // --- MODAL CLASS & FUNCTIONS ---
    class Modal {
        constructor(overlayId, containerId) {
            this.overlay = document.getElementById(overlayId);
            this.container = document.getElementById(containerId);
            this.body = this.container.querySelector('div'); // Assumes first div is the body
        }
        open(content) {
            if (content) this.body.innerHTML = content;
            this.overlay.classList.remove('hidden');
            setTimeout(() => {
                this.overlay.classList.remove('opacity-0');
                this.container.classList.remove('scale-95');
            }, 10);
        }
        close() {
            this.overlay.classList.add('opacity-0');
            this.container.classList.add('scale-95');
            setTimeout(() => this.overlay.classList.add('hidden'), 300);
        }
    }

    const openObjectiveDetailsModal = (objective) => {
        const statusPillClass = getStatusPillClass(objective.status);
        const content = `<div class="p-8 bg-gradient-to-r from-cyan-800 to-emerald-600 text-white rounded-t-xl">
                             <div class="flex justify-between items-start">
                                <div>
                                    <h2 class="text-3xl font-bold">${objective.name}</h2>
                                    <div class="flex items-center mt-2 space-x-4">
                                        <span class="status-pill ${statusPillClass} bg-white/20 text-white">${objective.status}</span>
                                        <p class="text-cyan-200">Target: ${objective.targetDate || 'Not set'}</p>
                                    </div>
                                </div>
                                <button class="objective-modal-close-btn text-cyan-200 hover:text-white text-3xl">&times;</button>
                            </div>
                        </div>
                        <div class="p-8 space-y-6 bg-slate-50 rounded-b-xl">
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-2">Current Results (<span class="capitalize">${objective.view}</span>)</h4>
                                <div class="flex gap-4">${createKpiCards(objective)}</div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white p-4 rounded-lg border"><h4 class="font-semibold text-slate-800">Objective Goal</h4><p class="text-slate-600 mt-1">${objective.kpiGoal || 'Not specified'}</p></div>
                                <div class="bg-white p-4 rounded-lg border"><h4 class="font-semibold text-slate-800">Next Steps</h4><p class="text-slate-600 mt-1">${objective.nextSteps || 'Not specified'}</p></div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border"><h4 class="font-semibold text-slate-800">Risks & Blockers</h4><p class="text-slate-600 mt-1">${objective.challenges || 'None identified'}</p>${objective.s4Link ? `<a href="${objective.s4Link}" target="_blank" class="text-cyan-600 text-sm hover:underline mt-2 inline-block">View in S4</a>` : ''}</div>
                        </div>`;
        objectiveModal.open(content);
    };

    const openAddObjectiveModal = () => {
        const content = `<div class="p-6">
                            <h3 class="text-lg font-semibold text-slate-900 mb-4">Add New Objective</h3>
                            <div class="space-y-4">
                                <div><label class="form-label">Objective Name</label><select id="new-objective-name" class="form-select">${objectiveOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}</select></div>
                                <div><label class="form-label">Target Date</label><input type="date" id="new-objective-date" class="form-input"></div>
                                <div><label class="form-label">Objective Goal</label><textarea id="new-objective-goal" class="form-textarea" rows="2" placeholder="e.g., Increase by 10%"></textarea></div>
                                <div><label class="form-label">Next Steps</label><textarea id="new-objective-steps" class="form-textarea" rows="2" placeholder="e.g., Schedule follow-up meeting..."></textarea></div>
                            </div>
                            <div class="mt-6 flex justify-end space-x-2">
                                <button class="objective-modal-close-btn bg-slate-200 text-slate-700 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300">Cancel</button>
                                <button id="save-new-objective-btn" class="bg-cyan-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-cyan-700">Add Objective</button>
                            </div>
                        </div>`;
        objectiveModal.open(content);
    };
    
    const openValueModal = (valueItem) => {
        state.editingValueId = valueItem.id;
        document.getElementById('value-description-input').value = valueItem.description;
        valueModal.open();
    };

    // --- HANDLER FUNCTIONS ---
    const handleAddObjective = (name, date, goal, steps) => {
        state.objectives.unshift({
            id: Date.now(), name, targetDate: date, status: 'Not Started', view: 'quarterly',
            challenges: '', s4Link: '', kpiGoal: goal, nextSteps: steps
        });
        renderObjectives();
        objectiveModal.close();
    };
    
    const handleAddValue = () => {
        state.valueRealized.push({ id: Date.now(), type: 'Time Savings', description: '', date: '', link: '' });
        renderValueRealized();
    };

    const handleAddMissionGoal = () => {
        state.missionGoals.push({ id: Date.now(), text: 'New Goal' });
        renderMissionGoals();
    };

    const handleAddStakeholder = (id) => {
        const contactToAdd = mockContacts.find(c => c.id === id);
        if (contactToAdd && !state.stakeholders.find(sc => sc.id === id)) {
            state.stakeholders.push(contactToAdd);
            renderStakeholders();
        }
    };

    const handleRemove = (id, list, cardSelector, renderFunc) => {
        const card = document.getElementById(`${cardSelector}-${id}`);
        if (card) {
            card.classList.add('removing');
            setTimeout(() => {
                const index = list.findIndex(item => item.id === id);
                if (index > -1) list.splice(index, 1);
                renderFunc();
            }, 300);
        }
    };

    const handleStatusChange = (id, newStatus) => {
        const objectiveIndex = state.objectives.findIndex(obj => obj.id === id);
        if (objectiveIndex === -1) return;
        const objective = state.objectives[objectiveIndex];
        objective.status = newStatus;

        if (newStatus === 'Completed') {
            const card = document.getElementById(`objective-${id}`);
            if (card) {
                card.classList.add('removing');
                setTimeout(() => {
                    const [completedObjective] = state.objectives.splice(objectiveIndex, 1);
                    state.pastObjectives.unshift(completedObjective);
                    renderObjectives();
                }, 300);
            }
        } else {
            renderObjectives();
        }
    };

    // --- EVENT LISTENERS ---
    document.getElementById('add-objective-btn').addEventListener('click', openAddObjectiveModal);
    document.getElementById('add-value-btn').addEventListener('click', handleAddValue);
    document.getElementById('add-mission-goal-btn').addEventListener('click', handleAddMissionGoal);
    
    document.getElementById('add-stakeholder-select').addEventListener('change', (e) => {
        const selectedId = parseInt(e.target.value, 10);
        if (selectedId) {
            handleAddStakeholder(selectedId);
            e.target.value = '';
        }
    });

    objectiveModal.overlay.addEventListener('click', (e) => {
        if (e.target === objectiveModal.overlay || e.target.closest('.objective-modal-close-btn')) {
            objectiveModal.close();
        }
        if (e.target.id === 'save-new-objective-btn') {
            const name = document.getElementById('new-objective-name').value;
            const date = document.getElementById('new-objective-date').value;
            const goal = document.getElementById('new-objective-goal').value;
            const steps = document.getElementById('new-objective-steps').value;
            handleAddObjective(name, date, goal, steps);
        }
    });
    
    document.getElementById('value-modal-cancel-btn').addEventListener('click', () => valueModal.close());
    valueModal.overlay.addEventListener('click', (e) => {
        if (e.target === valueModal.overlay) valueModal.close();
    });
    
    document.getElementById('value-modal-save-btn').addEventListener('click', () => {
        const item = state.valueRealized.find(v => v.id === state.editingValueId);
        if (item) {
            item.description = document.getElementById('value-description-input').value;
            renderValueRealized();
            valueModal.close();
        }
    });

    document.getElementById('app').addEventListener('click', e => {
        const removeValueBtn = e.target.closest('.remove-value-btn');
        if (removeValueBtn) {
            const id = parseInt(removeValueBtn.closest('.value-item').dataset.id, 10);
            handleRemove(id, state.valueRealized, 'value', renderValueRealized);
            return;
        }

        const removeStakeholderBtn = e.target.closest('.remove-stakeholder-btn');
        if (removeStakeholderBtn) {
            const id = parseInt(removeStakeholderBtn.closest('.stakeholder-card').dataset.id, 10);
            handleRemove(id, state.stakeholders, 'stakeholder', renderStakeholders);
            return;
        }

        const viewDetailsBtn = e.target.closest('.view-details-btn');
        if (viewDetailsBtn) {
            const id = parseInt(viewDetailsBtn.closest('.objective-card').dataset.id, 10);
            const objective = state.objectives.find(o => o.id === id) || state.pastObjectives.find(o => o.id === id);
            if (objective) openObjectiveDetailsModal(objective);
            return;
        }

        const editDescriptionBtn = e.target.closest('.edit-description-btn, .description-preview');
        if (editDescriptionBtn) {
            const id = parseInt(editDescriptionBtn.closest('.value-item').dataset.id, 10);
            const valueItem = state.valueRealized.find(v => v.id === id);
            if (valueItem) openValueModal(valueItem);
            return;
        }

        const removeMissionGoalBtn = e.target.closest('.remove-mission-goal-btn');
        if (removeMissionGoalBtn) {
            const id = parseInt(removeMissionGoalBtn.closest('.mission-goal-item').dataset.id, 10);
            handleRemove(id, state.missionGoals, 'mission-goal', renderMissionGoals);
            return;
        }

        const cycleViewBtn = e.target.closest('.cycle-view-btn');
        if (cycleViewBtn) {
            const card = cycleViewBtn.closest('.objective-card');
            const id = parseInt(card.dataset.id, 10);
            const objective = state.objectives.find(o => o.id === id);
            if (objective) {
                const currentIndex = timePeriods.indexOf(objective.view);
                objective.view = timePeriods[(currentIndex + 1) % timePeriods.length];
                renderObjectives();
            }
        }
    });

    document.getElementById('app').addEventListener('change', e => {
        if (e.target.classList.contains('status-select')) {
            const id = parseInt(e.target.closest('.objective-card').dataset.id, 10);
            handleStatusChange(id, e.target.value);
        }
    });

    // --- INITIAL RENDER ---
    renderAll();
    objectiveModal.overlay.classList.add('opacity-0');
    valueModal.overlay.classList.add('opacity-0');
});
</script>
</body>
</html>
